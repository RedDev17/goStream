<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>goStream – HD Zero-Lag (PH)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#2c2f33; color:#dcddde; min-height:100vh; }
    .card { background:#23272a; border:0; }
    #screenVideo { width:100%; height:100%; object-fit:contain; background:#000; }
    #screenContainer { position:relative; height:calc(100vh - 300px); min-height:350px; background:#111; overflow:hidden; border-radius:.5rem; }
    .fullscreen-btn { position:absolute; top:1rem; left:50%; transform:translateX(-50%); z-index:20; }
    .peer-item { display:inline-block; background:#40444b; padding:.25rem .5rem; margin:.15rem; border-radius:.25rem; font-size:.8rem; }
  </style>
</head>
<body class="d-flex flex-column">

<header class="bg-dark text-center py-4">
  <h1 class="display-5 fw-bold">goStream</h1>
  <p class="text-muted">HD • Zero-Lag • Philippines-Optimized</p>
</header>

<main class="flex-fill container py-4">

  <!-- ROOM -->
  <div class="card p-4 mb-4" id="roomSection">
    <div class="row g-3 align-items-end">
      <div class="col-md-8">
        <label class="form-label text-muted">Room Name</label>
        <input type="text" class="form-control" id="roomId" placeholder="e.g. meeting-01" autocomplete="off">
      </div>
      <div class="col-md-4 d-grid gap-2 d-md-flex">
        <button class="btn btn-primary flex-fill" onclick="createRoom()">Create</button>
        <button class="btn btn-outline-secondary flex-fill" onclick="joinRoom()">Join</button>
      </div>
    </div>

    <div id="roomInfo" class="mt-3 p-3 bg-dark rounded text-center d-none">
      <strong>Room:</strong> <span id="currentRoomName"></span><br>
      <strong>Your ID:</strong> <code id="myPeerId"></code>
    </div>
  </div>

  <!-- SHARE CONTROLS -->
  <div class="card p-4 mb-4 d-none" id="shareSection">
    <div class="d-grid d-md-flex gap-2 justify-content-center">
      <button class="btn btn-danger" id="stopShareBtn" onclick="stopSharing()">Stop Sharing</button>
      <button class="btn btn-success d-none" id="startShareBtn" onclick="startSharing()">Share Screen (HD)</button>
    </div>
  </div>

  <!-- VIDEO -->
  <div id="screenContainer" class="card d-none">
    <div id="screenPlaceholder" class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
      <h5>Waiting for stream…</h5>
    </div>
    <div id="screenDisplay" class="position-relative d-none">
      <button class="btn btn-sm btn-dark fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">Fullscreen</button>
      <video id="screenVideo" autoplay playsinline></video>
    </div>
  </div>

  <!-- STATUS -->
  <div class="alert alert-secondary mt-3" id="status">Status: Not connected</div>

  <!-- PEERS -->
  <div class="card p-3 d-none" id="peerList">
    <strong>Connected peers:</strong>
    <div id="peerItems" class="mt-2"></div>
  </div>

</main>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
/* ============================================================= */
/* ====================  GLOBALS  =============================== */
/* ============================================================= */
let peer = null, myId = null, roomName = null, isCreator = false, isSharing = false;
let hostStream = null, peers = new Map(), discoverInterval = null;
const $ = id => document.getElementById(id);

/* -------------------  PH-OPTIMIZED ICE  --------------------- */
function phIce() {
  return [
    { urls: 'stun:stun.singapore.trueconf.com:3478' },
    { urls: 'stun:stun.syncthing.net:3478' },
    { urls: 'stun:stun.hk.airasia.com:3478' },
    { urls: 'stun:stun.jp.zoom.us:3478' },
    { urls: 'stun:stun.qq.com:3478' },
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun.services.mozilla.com:3478' },
    { urls: 'stun:global.stun.twilio.com:3478' }
  ];
}

/* -------------------  PEER INIT  --------------------------- */
function initPeer(fixedId = null) {
  if (peer) peer.destroy();
  const cfg = {
    debug: 2,
    config: {
      iceServers: phIce(),
      iceCandidatePoolSize: 30,
      iceTransportPolicy: 'all',
      rtcpMuxPolicy: 'require',
      bundlePolicy: 'max-bundle'
    }
  };
  peer = fixedId ? new Peer(fixedId, cfg) : new Peer(cfg);

  peer.on('open', id => {
    myId = id;
    $('myPeerId').textContent = id;
    status('Connected – PH Optimized', 'success');
    showRoomUI();

    if (isCreator) {
      $('shareSection').classList.remove('d-none');
      if (!/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
        $('startShareBtn').classList.remove('d-none');
        setTimeout(startSharing, 2000);               // auto-share for creator
      }
    } else {
      discoverInterval = setInterval(discoverPeers, 2500);
    }
  });

  peer.on('connection', conn => {
    if (!peers.has(conn.peer)) setupConn(conn);
  });

  peer.on('error', err => {
    console.error(err);
    status(`Error: ${err.type}`, 'danger');
    if (['network','disconnected'].includes(err.type)) {
      setTimeout(() => roomName && initPeer(isCreator ? hashRoom(roomName) : null), 2000);
    }
  });
}

/* -------------------  HD SHARE  ---------------------------- */
async function startSharing() {
  if (isSharing) return;
  if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
    status('Screen sharing not supported on mobile', 'danger');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { cursor: 'always', width: {ideal:1280}, height: {ideal:720}, frameRate: {ideal:30} },
      audio: false
    });

    // optional mic
    try {
      const mic = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true, noiseSuppression:true}});
      mic.getAudioTracks().forEach(t=>stream.addTrack(t));
    } catch (_) {}

    hostStream = stream;
    const vid = $('screenVideo');
    vid.srcObject = stream;
    vid.muted = true;

    $('screenPlaceholder').classList.add('d-none');
    $('screenDisplay').classList.remove('d-none');
    $('stopShareBtn').style.display = 'inline-block';
    $('startShareBtn').classList.add('d-none');
    isSharing = true;
    broadcast({type:'sharing_started', host:myId});
    status('Streaming HD (zero-lag)', 'success');

    peers.forEach(c => c.open && sendStream(c, stream));
    stream.getTracks().forEach(t => t.onended = stopSharing);
  } catch (e) {
    console.error(e);
    status('Share failed: '+e.message, 'danger');
  }
}

/* -------------------  SEND STREAM  ------------------------- */
function sendStream(conn, stream) {
  if (!conn.open) return;
  const rtc = new RTCPeerConnection({
    iceServers: phIce(),
    iceCandidatePoolSize: 30,
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require'
  });
  conn._rtc = rtc;
  stream.getTracks().forEach(t => rtc.addTrack(t, stream));

  rtc.onicecandidate = e => e.candidate && conn.send({type:'ice', candidate:e.candidate});
  rtc.onnegotiationneeded = async () => {
    const offer = await rtc.createOffer();
    await rtc.setLocalDescription(offer);
    conn.send({type:'offer', sdp:rtc.localDescription});
  };
}

/* -------------------  CONNECTION  -------------------------- */
function setupConn(conn) {
  if (peers.has(conn.peer)) return;
  peers.set(conn.peer, conn);
  updatePeers();

  conn.on('open', () => {
    console.log('PH peer', conn.peer);
    if (isSharing && hostStream) sendStream(conn, hostStream);
  });

  conn.on('data', raw => {
    let data;
    try { data = typeof raw === 'string' ? JSON.parse(raw) : raw; } catch (_) { return; }
    if (!data.type) return;

    if (['offer','answer','ice'].includes(data.type)) { handleSDP(data, conn); return; }

    if (data.type === 'sharing_started') {
      status('Receiving HD stream', 'success');
      $('fullscreenBtn').classList.remove('d-none');
    }
    if (data.type === 'sharing_stopped') stopRemote();
  });

  conn.on('close', () => { peers.delete(conn.peer); updatePeers(); });
}

/* -------------------  SDP/ICE  ----------------------------- */
async function handleSDP(data, conn) {
  let rtc = conn._rtc;
  if (!rtc) {
    rtc = new RTCPeerConnection({iceServers: phIce(), iceCandidatePoolSize:30});
    conn._rtc = rtc;
    rtc.ontrack = e => {
      const vid = $('screenVideo');
      vid.srcObject = e.streams[0];
      vid.muted = false;
      $('screenPlaceholder').classList.add('d-none');
      $('screenDisplay').classList.remove('d-none');
      $('fullscreenBtn').classList.remove('d-none');
      unlockiOS();
      status('HD stream active', 'success');
    };
    rtc.onicecandidate = e => e.candidate && conn.send({type:'ice', candidate:e.candidate});
  }

  if (data.type === 'offer') {
    await rtc.setRemoteDescription(data.sdp);
    const ans = await rtc.createAnswer();
    await rtc.setLocalDescription(ans);
    conn.send({type:'answer', sdp:rtc.localDescription});
  } else if (data.type === 'answer') {
    await rtc.setRemoteDescription(data.sdp);
  } else if (data.type === 'ice' && data.candidate) {
    await rtc.addIceCandidate(data.candidate);
  }
}

/* -------------------  UI HELPERS  -------------------------- */
function hashRoom(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = ((h << 5) - h) + name.charCodeAt(i);
  return 'ph_room_' + Math.abs(h).toString(36).substr(0,12);
}
function createRoom() {
  roomName = $('roomId').value.trim() || 'pinas';
  if (!roomName) return alert('Enter a room name');
  cleanup();
  isCreator = true;
  initPeer(hashRoom(roomName));
}
function joinRoom() {
  roomName = $('roomId').value.trim() || 'pinas';
  if (!roomName) return alert('Enter a room name');
  cleanup();
  isCreator = false;
  initPeer();
}
function showRoomUI() {
  $('currentRoomName').textContent = roomName;
  $('roomInfo').classList.remove('d-none');
  $('screenContainer').classList.remove('d-none');
}
function discoverPeers() {
  if (isCreator || !peer || !peer.open) return;
  const target = hashRoom(roomName);
  if (target !== myId && !peers.has(target)) connectTo(target);
}
function connectTo(id) {
  if (peers.has(id) || id === myId) return;
  const c = peer.connect(id, {reliable:true, serialization:'json'});
  setupConn(c);
}
function stopSharing() {
  if (hostStream) hostStream.getTracks().forEach(t=>t.stop());
  hostStream = null; isSharing = false;
  stopRemote();
  $('stopShareBtn').style.display = 'none';
  $('startShareBtn').classList.remove('d-none');
  broadcast({type:'sharing_stopped'});
  status('Sharing stopped', 'secondary');
}
function stopRemote() {
  const vid = $('screenVideo');
  vid.srcObject = null;
  $('screenPlaceholder').classList.remove('d-none');
  $('screenDisplay').classList.add('d-none');
  $('fullscreenBtn').classList.add('d-none');
}
function broadcast(obj) { peers.forEach(c => c.open && c.send(obj)); }
function updatePeers() {
  const container = $('peerList'), list = $('peerItems');
  if (!peers.size) { container.classList.add('d-none'); return; }
  container.classList.remove('d-none');
  list.innerHTML = '';
  peers.forEach((_,id) => {
    const el = document.createElement('span');
    el.className = 'peer-item';
    el.textContent = id.slice(0,8)+'…';
    list.appendChild(el);
  });
}
function status(txt, type) {
  const el = $('status');
  el.textContent = 'Status: '+txt;
  el.className = 'alert mt-3 alert-' + (type==='success'?'success':type==='danger'?'danger':'secondary');
}
function toggleFullscreen() {
  const el = $('screenDisplay');
  if (!document.fullscreenElement) {
    (el.requestFullscreen || el.webkitRequestFullscreen).call(el);
    $('fullscreenBtn').textContent = 'Exit';
  } else {
    (document.exitFullscreen || document.webkitExitFullscreen).call(document);
    $('fullscreenBtn').textContent = 'Fullscreen';
  }
}
function unlockiOS() {
  const vid = $('screenVideo');
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    vid.muted = false;
    const play = () => vid.play().catch(()=>{}); 
    document.addEventListener('touchstart', play, {once:true});
  }
}
function cleanup() {
  if (discoverInterval) clearInterval(discoverInterval);
  if (hostStream) hostStream.getTracks().forEach(t=>t.stop());
  if (peer) peer.destroy();
  peers.clear(); updatePeers();
}

/* -------------------  INIT  -------------------------------- */
$('roomId').addEventListener('keypress', e=> e.key==='Enter' && createRoom());
window.addEventListener('beforeunload', cleanup);
</script>
</body>
</html>
